asyncapi: '2.6.0'
id: 'urn:pgj-2026:sheep-wolf-socket-api'
info:
  title: PGJ-2026 Sheep & Wolf Socket API
  version: '0.2.0'
  description: |
    Async API contract for the real-time multiplayer game.

    Transport: WebSocket (JSON messages).

    Message envelope:
    - Client and server send JSON objects with `type` and `payload`.
    - Requests may include `requestId` inside the `payload`, echoed back in the ack payload.

    Notes:
    - Hidden roles (e.g. wolf) are server-side only and are NOT broadcast in room state.

    Flow (high level):
    1) Client connects → server sends `SessionWelcome`.
    2) Client sends `RoomJoin` → server replies `RoomJoinAck`.
    3) Server broadcasts `RoomLobby` updates as players join/leave.
    4) Host sends `RoomStart` → server broadcasts `RoomStart` (with `startId`, `timeoutMs`).
    5) Each client replies `RoomStartAck` with position.
    6) Server assigns roles, sends `PlayerRole`, then starts `RoomState` broadcast loop.
    7) Clients send `PlayerPosition` regularly after start.
    8) Clients send `PenUpdate` when they enter or leave a pen.

defaultContentType: application/json
servers:
  default:
    url: http://localhost:3000
    protocol: ws
    description: WebSocket server

channels:
  # Server -> Client (events)
  SessionWelcome:
    description: Server -> Client event. Sent once after WebSocket connection.
    subscribe:
      summary: Server -> Client (event). Receive session metadata.
      x-requestType: event
      message:
        $ref: '#/components/messages/SessionWelcome'

  RoomJoinAck:
    description: Server -> Client ack. Acknowledgement for `RoomJoin`.
    subscribe:
      summary: Server -> Client (ack). Join result.
      x-requestType: ack
      message:
        $ref: '#/components/messages/RoomJoinAck'

  RoomLobby:
    description: Server -> Client event. Lobby updates before the room starts.
    subscribe:
      summary: Server -> Client (event). Lobby player list.
      x-requestType: event
      message:
        $ref: '#/components/messages/RoomLobby'

  RoomState:
    description: Server -> Client event. Authoritative room snapshot (20Hz).
    subscribe:
      summary: Server -> Client (event). Room state broadcast.
      x-requestType: event
      message:
        $ref: '#/components/messages/RoomState'

  DayStart:
    description: Server -> Client event. Day started.
    subscribe:
      summary: Server -> Client (event). Day start.
      x-requestType: event
      message:
        $ref: '#/components/messages/DayStart'

  DayEnd:
    description: Server -> Client event. Day ended.
    subscribe:
      summary: Server -> Client (event). Day end.
      x-requestType: event
      message:
        $ref: '#/components/messages/DayEnd'

  GameEnd:
    description: Server -> Client event. Game ended.
    subscribe:
      summary: Server -> Client (event). Game end.
      x-requestType: event
      message:
        $ref: '#/components/messages/GameEnd'

  PlayerRole:
    description: Server -> Client event. Role assigned after room start.
    subscribe:
      summary: Server -> Client (event). Receive your role.
      x-requestType: event
      message:
        $ref: '#/components/messages/PlayerRole'

  RoomStart:
    description: Start handshake.
    publish:
      summary: Client -> Server (request). Start the room.
      x-requestType: request
      message:
        $ref: '#/components/messages/RoomStart'
    subscribe:
      summary: Server -> Client (event). Start handshake request.
      x-requestType: event
      message:
        $ref: '#/components/messages/RoomStartNotice'

  GrassEat:
    description: Grass consumption update.
    publish:
      summary: Client -> Server (event). Report grass consumption.
      x-requestType: event
      message:
        $ref: '#/components/messages/GrassEat'
    subscribe:
      summary: Server -> Client (event). Grass consumption update.
      x-requestType: event
      message:
        $ref: '#/components/messages/GrassEat'

  # Client -> Server (requests/events)
  RoomJoin:
    description: Client -> Server request. Join (or create) a room.
    publish:
      summary: Client -> Server (request). Join by id + name.
      x-requestType: request
      message:
        $ref: '#/components/messages/RoomJoinRequest'

  RoomStartAck:
    description: Client -> Server ack. Reply to start handshake.
    publish:
      summary: Client -> Server (ack). Provide initial position.
      x-requestType: ack
      message:
        $ref: '#/components/messages/RoomStartAck'

  PlayerPosition:
    description: Client -> Server event. Player position update (frequent).
    publish:
      summary: Client -> Server (event). Send your current position.
      x-requestType: event
      message:
        $ref: '#/components/messages/PlayerPosition'

  PenUpdate:
    description: Client -> Server event. Player enters or leaves a pen.
    publish:
      summary: Client -> Server (event). Update pen state.
      x-requestType: event
      message:
        $ref: '#/components/messages/PenUpdate'

components:
  messages:
    SessionWelcome:
      name: SessionWelcome
      payload:
        type: object
        additionalProperties: false
        required: [type, payload]
        properties:
          type:
            type: string
            const: SessionWelcome
          payload:
            type: object
            additionalProperties: false
            required: [sessionId, serverTime, protocolVersion, authRequired]
            properties:
              sessionId:
                type: string
                description: WebSocket connection id
                examples: ['Jx2k8u2k3f...']
              serverTime:
                type: integer
                description: Server time in milliseconds since epoch
                examples: [1706688000000]
              protocolVersion:
                type: string
                description: Server protocol version
                examples: ['1.0.0']
              authRequired:
                type: boolean
                description: Whether authentication is required
                examples: [false]

    RoomJoinRequest:
      name: RoomJoin
      payload:
        type: object
        additionalProperties: false
        required: [type, payload]
        properties:
          type:
            type: string
            const: RoomJoin
          payload:
            type: object
            additionalProperties: false
            required: [roomId, name]
            properties:
              requestId:
                type: string
                description: Client-generated id used to correlate the ack
              roomId:
                type: string
                description: Room identifier (URL-safe)
                minLength: 1
                maxLength: 32
                pattern: '^[a-zA-Z0-9_-]{1,32}$'
                examples: ['lobby', 'team-1']
              name:
                type: string
                description: Display name (trimmed; max 24 chars)
                minLength: 1
                maxLength: 24
                examples: ['Player', 'Dimitris']

    RoomJoinAck:
      name: RoomJoinAck
      payload:
        type: object
        additionalProperties: false
        required: [type, payload]
        properties:
          type:
            type: string
            const: RoomJoinAck
          payload:
            oneOf:
              - type: object
                additionalProperties: false
                required: [requestId, ok, roomId, playerId]
                properties:
                  requestId:
                    type: string
                  ok:
                    type: boolean
                    const: true
                  roomId:
                    type: string
                  playerId:
                    type: string
                    description: Equals your WebSocket connection id
              - type: object
                additionalProperties: false
                required: [requestId, ok, error]
                properties:
                  requestId:
                    type: string
                  ok:
                    type: boolean
                    const: false
                  error:
                    type: string
                    description: Human-readable error message

    PlayerPosition:
      name: PlayerPosition
      payload:
        type: object
        additionalProperties: false
        required: [type, payload]
        properties:
          type:
            type: string
            const: PlayerPosition
          payload:
            type: object
            additionalProperties: false
            properties:
              x:
                type: number
                description: Player X position
                examples: [120, 400]
              y:
                type: number
                description: Player Y position
                examples: [200, 320]
            required: [x, y]

    PenUpdate:
      name: PenUpdate
      payload:
        type: object
        additionalProperties: false
        required: [type, payload]
        properties:
          type:
            type: string
            const: PenUpdate
          payload:
            type: object
            additionalProperties: false
            required: [inPen]
            properties:
              inPen:
                type: boolean
                description: Whether the player is currently inside a pen
              penId:
                type: string
                description: Pen id when inside a pen

    RoomState:
      name: RoomState
      payload:
        type: object
        additionalProperties: false
        required: [type, payload]
        properties:
          type:
            type: string
            const: RoomState
          payload:
            type: object
            additionalProperties: false
            required: [roomId, players, started, ended, day, totalDays, dayEndsAt]
            properties:
              roomId:
                type: string
              started:
                type: boolean
              ended:
                type: boolean
              day:
                type: integer
                minimum: 0
              totalDays:
                type: integer
                minimum: 1
              dayEndsAt:
                type: integer
                description: Timestamp (ms) when the current day ends
              players:
                type: array
                items:
                  $ref: '#/components/schemas/PlayerState'

    RoomStart:
      name: RoomStart
      payload:
        type: object
        additionalProperties: false
        required: [type]
        properties:
          type:
            type: string
            const: RoomStart
          payload:
            type: object
            additionalProperties: false
            properties:
              roomId:
                type: string
              grass:
                type: array
                description: Initial grass spawn ids generated by the client
                items:
                  type: object
                  additionalProperties: false
                  required: [id]
                  properties:
                    id:
                      type: string
                      description: Grass entity id (spawn point id)
              pens:
                type: array
                description: Initial pen spawn ids generated by the client
                items:
                  type: object
                  additionalProperties: false
                  required: [id]
                  properties:
                    id:
                      type: string
                      description: Pen entity id (spawn point id)

    RoomStartNotice:
      name: RoomStart
      payload:
        type: object
        additionalProperties: false
        required: [type, payload]
        properties:
          type:
            type: string
            const: RoomStart
          payload:
            type: object
            additionalProperties: false
            required: [roomId, startId, timeoutMs]
            properties:
              roomId:
                type: string
              startId:
                type: string
                description: Start handshake id
              timeoutMs:
                type: integer
                description: Time allowed for acks
              grass:
                type: array
                description: Grass spawn ids for the room
                items:
                  type: string
              pens:
                type: array
                description: Pen spawn ids for the room
                items:
                  type: string

    RoomStartAck:
      name: RoomStartAck
      payload:
        type: object
        additionalProperties: false
        required: [type, payload]
        properties:
          type:
            type: string
            const: RoomStartAck
          payload:
            type: object
            additionalProperties: false
            required: [startId, position]
            properties:
              startId:
                type: string
              position:
                type: object
                additionalProperties: false
                required: [x, y]
                properties:
                  x:
                    type: number
                  y:
                    type: number

    GrassEat:
      name: GrassEat
      payload:
        type: object
        additionalProperties: false
        required: [type, payload]
        properties:
          type:
            type: string
            const: GrassEat
          payload:
            type: object
            additionalProperties: false
            required: [grassId]
            properties:
              grassId:
                type: string

    PlayerRole:
      name: PlayerRole
      payload:
        type: object
        additionalProperties: false
        required: [type, payload]
        properties:
          type:
            type: string
            const: PlayerRole
          payload:
            type: object
            additionalProperties: false
            required: [roomId, role]
            properties:
              roomId:
                type: string
              role:
                type: string
                enum: ['sheep', 'wolf']

    DayStart:
      name: DayStart
      payload:
        type: object
        additionalProperties: false
        required: [type, payload]
        properties:
          type:
            type: string
            const: DayStart
          payload:
            type: object
            additionalProperties: false
            required: [roomId, day, dayEndsAt]
            properties:
              roomId:
                type: string
              day:
                type: integer
                minimum: 1
              dayEndsAt:
                type: integer
                description: Timestamp (ms) when the day ends

    DayEnd:
      name: DayEnd
      payload:
        type: object
        additionalProperties: false
        required: [type, payload]
        properties:
          type:
            type: string
            const: DayEnd
          payload:
            type: object
            additionalProperties: false
            required: [roomId, day]
            properties:
              roomId:
                type: string
              day:
                type: integer
                minimum: 1

    GameEnd:
      name: GameEnd
      payload:
        type: object
        additionalProperties: false
        required: [type, payload]
        properties:
          type:
            type: string
            const: GameEnd
          payload:
            type: object
            additionalProperties: false
            required: [roomId, winner, reason]
            properties:
              roomId:
                type: string
              winner:
                type: string
                enum: [sheep, wolves]
              reason:
                type: integer
                enum: [0, 1, 2]
                x-enumNames: [WOLVES_ELIMINATED, SHEEP_ELIMINATED, SURVIVED_DAYS]

    RoomLobby:
      name: RoomLobby
      payload:
        type: object
        additionalProperties: false
        required: [type, payload]
        properties:
          type:
            type: string
            const: RoomLobby
          payload:
            type: object
            additionalProperties: false
            required: [roomId, players, started]
            properties:
              roomId:
                type: string
              players:
                type: array
                items:
                  type: string
              started:
                type: boolean

  schemas:
    EntityState:
      type: object
      additionalProperties: false
      required: [id, type, color, x, y]
      properties:
        id:
          type: string
        type:
          type: string
          description: Entity type (e.g. player)
          examples: ['player']
        color:
          type: string
          description: Hex color (currently used by demo client)
          pattern: '^#([0-9a-fA-F]{6})$'
          examples: ['#ffcc00']
        x:
          type: integer
        y:
          type: integer

    PlayerState:
      allOf:
        - $ref: '#/components/schemas/EntityState'
        - type: object
          additionalProperties: false
          required: [name, isAlive, inPen]
          properties:
            name:
              type: string
              maxLength: 24
            isAlive:
              type: boolean
            inPen:
              type: boolean
            penId:
              type: string
            deathReason:
              type: integer
              description: Reason for death (if applicable)
              enum: [0, 1, 2, 3]
              x-enumNames: [WOLF_IN_PEN, NOT_IN_PEN, NOT_ENOUGH_GRASS, WOLF_HUNGER]

x-implementation-notes:
  tickRateHz: 20
  serverAuthoritative: true
  roleVisibility:
    role: server-only
