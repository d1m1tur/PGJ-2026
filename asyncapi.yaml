asyncapi: '2.6.0'
id: 'urn:pgj-2026:sheep-wolf-socket-api'
info:
  title: PGJ-2026 Sheep & Wolf Socket API
  version: '0.2.0'
  description: |
    Async API contract for the real-time multiplayer game.

    Transport: WebSocket (JSON messages).

    Message envelope:
    - Client and server send JSON objects with `type` and `payload`.
    - Requests may include `requestId`, echoed back in the ack.

    Notes:
    - All players visually appear as `appearance: sheep`.
    - Hidden roles (e.g. wolf) are server-side only and are NOT broadcast in room state.

defaultContentType: application/json
servers:
  default:
    url: http://localhost:3000
    protocol: ws
    description: WebSocket server

channels:
  session:welcome:
    description: Sent once after WebSocket connection.
    subscribe:
      summary: Receive session metadata from the server.
      message:
        $ref: '#/components/messages/SessionWelcome'

  room:join:
    description: Join (or create) a room.
    publish:
      summary: Join a room by id and display name.
      message:
        $ref: '#/components/messages/RoomJoinRequest'

  room:join:ack:
    description: Acknowledgement payload for `room:join`.
    subscribe:
      summary: Ack with success/error and assigned player id.
      message:
        $ref: '#/components/messages/RoomJoinAck'

  player:input:
    description: Player movement input (client -> server). Sent frequently.
    publish:
      summary: Send movement input state.
      message:
        $ref: '#/components/messages/PlayerInput'

  room:state:
    description: Authoritative room snapshot broadcast by server (20Hz).
    subscribe:
      summary: Receive the latest world + player states.
      message:
        $ref: '#/components/messages/RoomState'

  room:start:
    description: Start the room (server begins ticking and broadcasting).
    publish:
      summary: Request the server to start the room.
      message:
        $ref: '#/components/messages/RoomStart'
    subscribe:
      summary: Notification that the room has started.
      message:
        $ref: '#/components/messages/RoomStartNotice'

components:
  messages:
    SessionWelcome:
      name: session:welcome
      payload:
        type: object
        additionalProperties: false
        required: [type, payload]
        properties:
          type:
            type: string
            const: session:welcome
          payload:
            type: object
            additionalProperties: false
            required: [sessionId, serverTime, protocolVersion, authRequired]
            properties:
              sessionId:
                type: string
                description: WebSocket connection id
                examples: ['Jx2k8u2k3f...']
              serverTime:
                type: integer
                description: Server time in milliseconds since epoch
                examples: [1706688000000]
              protocolVersion:
                type: string
                description: Server protocol version
                examples: ['1.0.0']
              authRequired:
                type: boolean
                description: Whether authentication is required
                examples: [false]

    RoomJoinRequest:
      name: room:join
      payload:
        type: object
        additionalProperties: false
        required: [type, payload]
        properties:
          type:
            type: string
            const: room:join
          requestId:
            type: string
            description: Client-generated id used to correlate the ack
          payload:
            type: object
            additionalProperties: false
            required: [roomId, name]
            properties:
              roomId:
                type: string
                description: Room identifier (URL-safe)
                minLength: 1
                maxLength: 32
                pattern: '^[a-zA-Z0-9_-]{1,32}$'
                examples: ['lobby', 'team-1']
              name:
                type: string
                description: Display name (trimmed; max 24 chars)
                minLength: 1
                maxLength: 24
                examples: ['Player', 'Dimitris']

    RoomJoinAck:
      name: room:join:ack
      payload:
        type: object
        additionalProperties: false
        required: [type, payload]
        properties:
          type:
            type: string
            const: room:join:ack
          requestId:
            type: string
            description: Echoes the requestId from the join request
          payload:
            oneOf:
              - type: object
                additionalProperties: false
                required: [ok, roomId, playerId, world, role]
                properties:
                  ok:
                    type: boolean
                    const: true
                  roomId:
                    type: string
                  playerId:
                    type: string
                    description: Equals your WebSocket connection id
                  role:
                    type: string
                    description: Local-only role for the joining player
                    enum: ['sheep', 'wolf']
                  world:
                    $ref: '#/components/schemas/World'
              - type: object
                additionalProperties: false
                required: [ok, error]
                properties:
                  ok:
                    type: boolean
                    const: false
                  error:
                    type: string
                    description: Human-readable error message

    PlayerInput:
      name: player:input
      payload:
        type: object
        additionalProperties: false
        required: [type, payload]
        properties:
          type:
            type: string
            const: player:input
          payload:
            type: object
            additionalProperties: false
            properties:
              x:
                type: number
                description: Movement X axis (-1..1)
                examples: [0, 1, -1]
              y:
                type: number
                description: Movement Y axis (-1..1)
                examples: [0, 1, -1]
            required: [x, y]

    RoomState:
      name: room:state
      payload:
        type: object
        additionalProperties: false
        required: [type, payload]
        properties:
          type:
            type: string
            const: room:state
          payload:
            type: object
            additionalProperties: false
            required: [roomId, world, players, started]
            properties:
              roomId:
                type: string
              started:
                type: boolean
              world:
                $ref: '#/components/schemas/World'
              players:
                type: array
                items:
                  $ref: '#/components/schemas/PlayerState'

    RoomStart:
      name: room:start
      payload:
        type: object
        additionalProperties: false
        required: [type]
        properties:
          type:
            type: string
            const: room:start
          payload:
            type: object
            additionalProperties: false
            properties:
              roomId:
                type: string

    RoomStartNotice:
      name: room:start
      payload:
        type: object
        additionalProperties: false
        required: [type, payload]
        properties:
          type:
            type: string
            const: room:start
          payload:
            type: object
            additionalProperties: false
            required: [roomId]
            properties:
              roomId:
                type: string

  schemas:
    World:
      type: object
      additionalProperties: false
      required: [width, height]
      properties:
        width:
          type: integer
          minimum: 1
          examples: [800]
        height:
          type: integer
          minimum: 1
          examples: [450]

    EntityState:
      type: object
      additionalProperties: false
      required: [id, type, appearance, isAlive, color, x, y]
      properties:
        id:
          type: string
        type:
          type: string
          description: Entity type (e.g. player)
          examples: ['player']
        appearance:
          type: [string, 'null']
          description: "Visual identity (players: 'sheep')"
          examples: ['sheep']
        isAlive:
          type: boolean
        color:
          type: string
          description: Hex color (currently used by demo client)
          pattern: '^#([0-9a-fA-F]{6})$'
          examples: ['#ffcc00']
        x:
          type: integer
        y:
          type: integer

    PlayerState:
      allOf:
        - $ref: '#/components/schemas/EntityState'
        - type: object
          additionalProperties: false
          required: [name]
          properties:
            name:
              type: string
              maxLength: 24

x-implementation-notes:
  tickRateHz: 20
  serverAuthoritative: true
  roleVisibility:
    role: server-only
    appearance: broadcast
